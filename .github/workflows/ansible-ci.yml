name: Ansible CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  ansible-checks:
    name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Ansible
    runs-on: ubuntu-latest

    steps:
      - name: üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞
        uses: actions/checkout@v4

      - name: üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Ansible
        run: |
          sudo apt update
          sudo apt install -y software-properties-common
          sudo add-apt-repository --yes --update ppa:ansible/ansible
          sudo apt install -y ansible

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –ø–ª–µ–π–±—É–∫–æ–≤
        run: |
          ansible-playbook --syntax-check playbooks/*.yml

      - name: üßπ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å –ø–æ–º–æ—â—å—é ansible-lint
        run: |
          sudo apt install -y ansible-lint
          ansible-lint playbooks/*.yml

      - name: üê≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker
        run: |
          sudo apt install -y docker.io

      - name: üß± –°–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–∞
        run: |
          docker build -t ubuntu-sshd .

      - name: üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        run: |
          docker run -d --name server1 -p 2201:22 -p 8001:80 ubuntu-sshd

      - name: üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH-–∫–ª—é—á–∞
        run: |
          ssh-keygen -t rsa -b 4096 -N "" -f ~/.ssh/id_rsa
          cat ~/.ssh/id_rsa.pub | ssh root@localhost -p 2201 "mkdir -p /root/.ssh && cat >> /root/.ssh/authorized_keys"
        env:
          SSH_AUTH_SOCK: /tmp/ssh_agent.sock

      - name: üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–µ–π–±—É–∫–∞
        run: |
          ansible-playbook -i hosts.yml playbooks/deploy-nginx.yml --check

      - name: üßæ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        if: ${{ failure() }}
        run: |
          echo "‚ùå –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —Å –æ—à–∏–±–∫–∞–º–∏!"
