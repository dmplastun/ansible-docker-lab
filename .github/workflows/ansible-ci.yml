name: Ansible CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  ansible-checks:
    name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Ansible
    runs-on: ubuntu-latest

    steps:
      - name: üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞
        uses: actions/checkout@v4

      - name: üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Ansible
        run: |
          sudo apt update
          sudo apt install -y software-properties-common
          sudo add-apt-repository --yes --update ppa:ansible/ansible
          sudo apt install -y ansible

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –ø–ª–µ–π–±—É–∫–æ–≤
        run: |
          ansible-playbook --syntax-check playbooks/*.yml

      - name: üßπ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å –ø–æ–º–æ—â—å—é ansible-lint
        run: |
          sudo apt install -y ansible-lint
          ansible-lint playbooks/*.yml

      - name: üê≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker
        run: |
          # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π (–µ—Å–ª–∏ –±—ã–ª–∏)
          sudo apt remove -y docker docker-engine docker.io containerd runc || true
      
          # –û—á–∏—Å—Ç–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
          sudo apt autoremove -y
      
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
          sudo apt update
          sudo apt install -y ca-certificates curl gnupg
      
          # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ GPG-–∫–ª—é—á–∞ Docker
          sudo install -m 0755 -d /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg  | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      
          # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Docker
          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu  \
            $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
      
          # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
          sudo apt update
      
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker
          sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
      
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
          docker --version
          sudo docker run hello-world

      - name: üß± –°–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–∞
        run: |
          docker build -t ubuntu-sshd ./files/

      - name: üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        run: |
          docker run -d --name server1 -p 2201:22 -p 8001:80 ubuntu-sshd

      - name: üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH-–∫–ª—é—á–∞
        run: |
          ssh-keygen -t rsa -b 4096 -N "" -f ~/.ssh/id_rsa
          cat ~/.ssh/id_rsa.pub | ssh root@localhost -p 2201 "mkdir -p /root/.ssh && cat >> /root/.ssh/authorized_keys"
        env:
          SSH_AUTH_SOCK: /tmp/ssh_agent.sock

      - name: üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–µ–π–±—É–∫–∞
        run: |
          ansible-playbook -i hosts.yml playbooks/deploy-nginx.yml --check

      - name: üßæ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        if: ${{ failure() }}
        run: |
          echo "‚ùå –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —Å –æ—à–∏–±–∫–∞–º–∏!"
